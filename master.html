<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <script src="jquery-1.9.0.js"></script>
        <link rel="stylesheet" href="common.css" type="text/css" media="all">
        <title></title>
    </head>
    <body>
        <div id="view">
            <div class="slide current" style="background-color: red;">
                Slide 1
            </div>
            <div class="slide" style="background-color: orange;">
                Slide 2
            </div>
            <div class="slide" style="background-color: yellow;">
                Slide 3
            </div>
            <div class="slide" style="background-color: green;">
                Slide 4
            </div>
            <div class="slide" style="background-color: skyblue;">
                Slide 5
            </div>
            <div class="slide" style="background-color: blue;">
                Slide 6
            </div>
            <div class="slide" style="background-color: purple;">
                Slide 7
            </div>
        </div>
        <button id="go-prev">Prev</button>
        <button id="go-next">Next</button>
        <div id="output"></div>
        <script>
            $(function() {
                var ws = null;
                function startWebSocket() {
                    ws = new WebSocket("ws://133.5.24.189:8888/");
                    ws.onclose = function() {
                        setTimeout(function() { startWebSocket(); }, 0);
                    };
                }
                startWebSocket();

                $('div.slide').append('<canvas class="overlay"></canvas>');
                $.each($('div.slide > canvas.overlay'), function(i, canvas) {
                    canvas.width = $(canvas).parent().width();
                    canvas.height = $(canvas).parent().height();

                    function getTouchPosition(t) {
                        return {
                            'x': t.pageX - $(canvas).offset().left,
                            'y': t.pageY - $(canvas).offset().top
                        };
                    }

                    var last_pos = null;
                    $(canvas).on('mousedown touchstart', function(e) {
                        last_pos = e.type === 'mousedown'  ? { 'x': e.offsetX, 'y': e.offsetY }
                                 : e.type === 'touchstart' ? getTouchPosition(e.originalEvent.touches[0])
                                 : alert('Impossible event type "' + e.type + '"');
                    });
                    $(canvas).on('mousemove touchmove', function(e) {
                        if (last_pos) {
                            var ctx = canvas.getContext('2d');
                            ctx.strokeStyle = 'black';
                            ctx.lineWidth = 4;
                            ctx.lineCap = 'round';
                            ctx.lineJoin = 'round';

                            var pos = e.type === 'mousemove' ? { 'x': e.offsetX, 'y': e.offsetY }
                                    : e.type === 'touchmove' ? getTouchPosition(e.originalEvent.touches[0])
                                    : alert('Impossible event type "' + e.type + '"');
                            ctx.moveTo(last_pos.x, last_pos.y);
                            ctx.lineTo(pos.x, pos.y);
                            ctx.stroke();
                            ws.send('line ' + JSON.stringify({ 'from': last_pos, 'to': pos }));
                            last_pos = pos;
                        }
                        e.preventDefault();
                    });
                    $(canvas).on('mouseup touchend', function(e) {
                        last_pos = null;
                    });
                });

                function updateSlideClasses() {
                    $('div.slide.current').prevAll('div.slide').removeClass('prev left');
                    $('div.slide.current').nextAll('div.slide').removeClass('next right');

                    $('div.slide.current').prevAll('div.slide').addClass('left');
                    $('div.slide.current').nextAll('div.slide').addClass('right');

                    $('div.slide.current').prev('div.slide').addClass('prev');
                    $('div.slide.current').next('div.slide').addClass('next');
                }

                updateSlideClasses();
                $('#go-prev').on('click', function(e) {
                    ws.send('prev');

                    if ($('div.slide.current').prev('div.slide').length > 0) {
                        $('div.slide.current').removeClass('current');
                        $('div.slide.prev').addClass('current');
                        $('div.slide.prev').removeClass('prev left');

                        updateSlideClasses();
                    }
                });
                $('#go-next').on('click', function(e) {
                    ws.send('next');

                    if ($('div.slide.current').next('div.slide').length > 0) {
                        $('div.slide.current').removeClass('current');
                        $('div.slide.next').addClass('current');
                        $('div.slide.next').removeClass('next right');

                        updateSlideClasses();
                    }
                });
            });
        </script>
    </body>
</html>
