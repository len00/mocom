<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <script src="jquery-1.9.0.js"></script>
        <link rel="stylesheet" href="common.css" type="text/css" media="all">
        <title></title>
    </head>
    <body>
        <div id="view">
        </div>
        <div>
            <textarea id="comment-entry" cols="40" rows="5" autofocus></textarea>
            <div id="comments"></div>
        </div>
        <script>
            $(function() {
                function updateSlideClasses() {
                    $('div.slide.current').prevAll('div.slide').removeClass('prev left');
                    $('div.slide.current').nextAll('div.slide').removeClass('next right');

                    $('div.slide.current').prevAll('div.slide').addClass('left');
                    $('div.slide.current').nextAll('div.slide').addClass('right');

                    $('div.slide.current').prev('div.slide').addClass('prev');
                    $('div.slide.current').next('div.slide').addClass('next');
                }

                function goToPrevSlide() {
                    if ($('div.slide.current').prev('div.slide').length > 0) {
                        $('div.slide.current').removeClass('current');
                        $('div.slide.prev').addClass('current');
                        $('div.slide.prev').removeClass('prev left');

                        updateSlideClasses();
                    }
                }

                function goToNextSlide() {
                    if ($('div.slide.current').next('div.slide').length > 0) {
                        $('div.slide.current').removeClass('current');
                        $('div.slide.next').addClass('current');
                        $('div.slide.next').removeClass('next right');

                        updateSlideClasses();
                    }
                }

                var ws = null;
                function startWebSocket() {
                    ws = new WebSocket("ws://" + window.location.hostname + ":8888/");
                    ws.onmessage = function(e) {
                        var msg = JSON.parse(e.data);
                        if (msg.type === "prev") {
                            goToPrevSlide();
                        }
                        else if (msg.type === "next") {
                            goToNextSlide();
                        }
                        else if (msg.type === "comment") {
                            $('<p>' + msg.body + '</p>').prependTo('#comments');
                        }
                        else if (msg.type === "line") {
                            var ctx = $('div.slide.current > canvas.overlay')[0].getContext('2d');
                            ctx.strokeStyle = 'black';
                            ctx.lineWidth = 4;
                            ctx.lineCap = 'round';
                            ctx.lineJoin = 'round';

                            var last_pos = msg.from;
                            var pos = msg.to;
                            ctx.moveTo(last_pos.x, last_pos.y);
                            ctx.lineTo(pos.x, pos.y);
                            ctx.stroke();
                            last_pos = pos;
                        }
                    };
                    ws.onclose = function() {
                        setTimeout(function() { startWebSocket(); }, 0);
                    };
                }
                startWebSocket();

                $.get('slide.html', function(data) {
                    $('#view').html(data);

                    $('div.slide').first().addClass('current');
                    $('div.slide').append('<canvas class="overlay"></canvas>');
                    $.each($('div.slide > canvas.overlay'), function(i, canvas) {
                        canvas.width = $(canvas).parent().width();
                        canvas.height = $(canvas).parent().height();
                    });

                    updateSlideClasses();
                });

                $('#comment-entry').on('keypress', function(e) {
                    if (!e.ctrlKey && e.which === 13) {
                        var s = $(this).val();
                        if (s.length > 0) {
                            var msg = { 'type': 'comment', 'body': s };
                            ws.send(JSON.stringify(msg));
                            $(this).val('');
                        }
                        e.preventDefault();
                    }
                    else if (e.which === 10 || (e.ctrlKey && e.which === 13)) {
                        var s = $(this).val();
                        var start = this.selectionStart;
                        var end = this.selectionEnd;
                        $(this).val(s.slice(0, start) + "\n" + s.slice(end));
                        this.selectionStart = start + 1;
                        this.selectionEnd = start + 1;
                    }
                });
            });
        </script>
    </body>
</html>
